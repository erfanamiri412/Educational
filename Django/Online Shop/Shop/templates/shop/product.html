{% extends "shop/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container my-5">
  {% if product %}
  <div class="card shadow-sm mx-auto" style="max-width: 540px;">
    <div class="card-img-top text-center p-3">
      <img src="{{ product.picture.url }}" class="img-fluid rounded" alt="{{ product.name }}">
    </div>
    <div class="card-body">
      <h5 class="card-title text-center">{{ product.name }}</h5>
      <p class="card-text text-center">{{ product.description }}</p>

      <div class="d-flex justify-content-center mb-2">
        {% for i in "12345"|make_list %}
          {% if forloop.counter <= product.star|default:0 %}
            <i class="bi bi-star-fill text-warning"></i>
          {% else %}
            <i class="bi bi-star text-secondary"></i>
          {% endif %}
        {% endfor %}
      </div>

      <div class="text-center mb-3">
        {% if product.is_sale %}
          <div class="text-muted text-decoration-line-through">{{ product.price|intcomma }} تومان</div>
          <div class="fw-bold text-success">{{ product.sale_price|intcomma }} تومان</div>
        {% else %}
          <div class="fw-bold">{{ product.price|intcomma }} تومان</div>
        {% endif %}
      </div>

      <div class="mt-4">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <button id="add-to-cart" class="btn btn-outline-success w-100" data-id="{{ product.id }}">
          <i class="bi bi-cart-plus me-1"></i> اضافه کردن به سبد خرید
        </button>
      </div>

      <div class="mt-3">
        <a href="{% url 'index' %}" class="btn btn-outline-secondary w-100">
          <i class="bi bi-arrow-left-circle me-1"></i> بازگشت به صفحه اصلی
        </a>
      </div>
    </div>
  </div>
  {% else %}
  <div class="alert alert-warning text-center mt-5">
    محصولی برای نمایش وجود ندارد.
  </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const btn = document.getElementById("add-to-cart");
  btn.addEventListener("click", function () {
    const productId = this.dataset.id;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("{% url 'cart_add' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrfToken
      },
      body: `product_id=${productId}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.exists) {
        if (!confirm("این محصول قبلاً در سبد شما هست! آیا می‌خواهید دوباره اضافه شود؟")) {
          return;
        }
      }
      alert("✅ محصول با موفقیت افزوده شد!");
      const cartQty = document.getElementById('cart-quantity');
      if (cartQty && data.qty !== undefined) {
        cartQty.textContent = data.qty;
      }
    })
    .catch(error => {
      console.error("❌ خطا در افزودن به سبد:", error);
      alert("مشکلی در افزودن محصول رخ داد.");
    });
  });
});
</script>
{% endblock content %}